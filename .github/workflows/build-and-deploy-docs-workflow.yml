name: Shared Build DocC docs and Deploy

on:
  workflow_call:
    inputs:
      package_name:
        type: string
        required: true
        description: "The name of the package to build docs for."
      modules:
        type: string
        required: true
        description: "The modules in the package to build docs for."
      pathsToInvalidate:
        type: string
        required: true
        description: "The paths to invalidate in CloudFront, e.g. '/vapor /xctvapor'."
  workflow_dispatch:
    inputs:
      repository:
        type: string
        required: true
        description: "The repository of the package to build docs for."
      package_name:
        type: string
        required: true
        description: "The name of the package to build docs for."
      modules:
        type: string
        required: true
        description: "The modules in the package to build docs for."
      pathsToInvalidate:
        type: string
        required: true
        description: "The paths to invalidate in CloudFront, e.g. '/vapor /xctvapor'."

jobs:

  build-docs:
    runs-on: ubuntu-latest
    container: swiftlang/swift:nightly-5.9-jammy@sha256:a3c3ec5e4436c14e44759e38416bb0d46813dc6dd050e787ef3a80b2c3051a36
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repository || github.repository }}
          fetch-depth: 0
      - name: Install curl and awscliv2
        run: | 
          apt-get update && apt-get install -y curl
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          ./aws/install
      - name: Download Files
        run: | 
          curl -sL \
            https://raw.githubusercontent.com/vapor/api-docs/main/generate-package-api-docs.swift -o generate-package-api-docs.swift \
            https://raw.githubusercontent.com/vapor/api-docs/main/theme-settings.json -o theme-settings.json
      - name: Builds Docs
        env:
          PACKAGE: ${{ inputs.package_name }}
          MODULES: ${{ inputs.modules }}
        run: swift generate-package-api-docs.swift ${PACKAGE} ${MODULES}
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.API_DOCS_DEPLOYER_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.API_DOCS_DEPLOYER_AWS_SECRET_ACCESS_KEY }}
          aws-region: 'eu-west-2'
      - name: Deploy to S3 and invalidate CloudFront
        env:
          DISTRIBUTION_ID: ${{ secrets.VAPOR_API_DOCS_DISTRIBUTION_ID }}
          INVALIDATE_PATHS: ${{ inputs.pathsToInvalidate }}
        run: |
          aws --no-cli-pager s3 sync \
            ./public s3://vapor-api-docs-site \
            --no-progress \
            --acl public-read
          aws --no-cli-pager cloudfront create-invalidation \
            --distribution-id ${DISTRIBUTION_ID} \
            --paths ${INVALIDATE_PATHS}
