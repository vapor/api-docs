name: Shared Build DocC docs and Deploy

on:
  workflow_call:
    inputs:
      package_name:
        type: string
        required: true
        description: "The name of the package to build docs for."
      modules:
        type: string
        required: true
        description: "The modules in the package to build docs for."
      pathsToInvalidate:
        type: string
        required: true
        description: "The paths to invalidate in CloudFront, e.g. '/vapor /xctvapor'."
  workflow_dispatch:
    inputs:
      repository:
        type: string
        required: true
        description: "The repository of the package to build docs for."
      package_name:
        type: string
        required: true
        description: "The name of the package to build docs for."
      modules:
        type: string
        required: true
        description: "The modules in the package to build docs for."
      pathsToInvalidate:
        type: string
        required: true
        description: "The paths to invalidate in CloudFront, e.g. '/vapor /xctvapor'."

jobs:

  build-docs:
    runs-on: ubuntu-latest
    permissions: { id-token: write, contents: read }
    container: swift:5.9-jammy
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository || github.repository }}
          fetch-depth: 0
      - name: Install curl and awscliv2
        run: | 
          apt-get update && apt-get install -y curl
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          ./aws/install
      - name: Download files
        run: | 
          curl -sL \
            "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/generate-package-api-docs.swift" \
              -o generate-package-api-docs.swift \
            "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/theme-settings.json" \
              -o theme-settings.json
      - name: Build docs
        run: |
          swift generate-package-api-docs.swift "${INPUT_PACKAGE_NAME}" ${INPUT_MODULES}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::177420307256:role/GithubOIdP-Role-zJ3kkJbhrNkr
          aws-region: 'eu-west-2'
      - name: Deploy to S3 and invalidate CloudFront
        env:
          S3_BUCKET_URL: ${{ secrets.VAPOR_API_DOCS_S3_BUCKET_URL }}
          DISTRIBUTION_ID: ${{ secrets.VAPOR_API_DOCS_DISTRIBUTION_ID }}
        run: |
          aws --no-cli-pager s3 sync \
            ./public "${S3_BUCKET_URL}" \
            --no-progress \
            --acl public-read
          aws --no-cli-pager cloudfront create-invalidation \
            --distribution-id "${DISTRIBUTION_ID}" \
            --paths "${INPUT_PATHSTOINVALIDATE}"
